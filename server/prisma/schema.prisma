generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum PlanType {
  FREE
  BASIC
  PRO
}

enum Role {
  USER
  ADMIN
}

enum RenderStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum CreditType {
  PURCHASE
  RENDER
  REFUND
  BONUS
  SUBSCRIPTION
}

model NexrenderTemplate {
  id           String @id @default(uuid())
  templateId   Int    @unique
  nexrenderId  String @unique
  displayName  String
  status       String
  compositions Json
  layers       Json?
  layerMapping Json?  // Stores mapping: { "text1": "actual layer name", ... }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("nexrender_templates")
}

model RenderJob {
  id                 String       @id @default(uuid())
  userId             String
  templateId         Int
  status             RenderStatus @default(PENDING)
  nexrenderJobId     String?      @unique
  creditsUsed        Int          @default(1)
  outputUrl          String?
  nexrenderOutputUrl String?
  error              String?
  customizations     Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([nexrenderJobId])
  @@map("render_jobs")
}

model User {
  id       String   @id @default(uuid())
  fullName String
  email    String   @unique
  password String?
  role     Role     @default(USER)
  avatar   String?  @default("")
  credits  Int      @default(5)
  planType PlanType @default(FREE)
  provider String   @default("email")
  googleId String?  @unique
  appleId  String?  @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

 
  renderJobs         RenderJob[]
  creditTransactions CreditTransaction[]

  @@map("users")
}

model CreditTransaction {
  id          String     @id @default(cuid())
  userId      String
  amount      Int // Positive for credits added, negative for credits used
  type        CreditType
  description String?
  renderJobId String? // Link to render job if applicable
  createdAt   DateTime   @default(now())

  // âœ… Add relation to User
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("credit_transactions")
}